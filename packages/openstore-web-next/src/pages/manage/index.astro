---
import ManageList from "@/components/manage/ManageList.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getUser } from "@/lib/user";

export const prerender = false;

const url = new URL(Astro.request.url);

if (url.searchParams.has("key")) {
  const expires = new Date();
  expires.setDate(expires.getDate() + 14);

  Astro.cookies.set("apikey", url.searchParams.get("key")!, { expires, path: "/" });
  return Astro.redirect("/manage/");
}

const apikey = Astro.cookies.get("apikey")?.value;
if (!apikey) {
  return Astro.redirect("/login/");
}

const user = await getUser(apikey);
if (!user) {
  Astro.cookies.delete("apikey");
  return Astro.redirect("/login/");
}
---

<BaseLayout title="OpenStore" pageTitle="Manage | OpenStore" description="The open source app store for Ubuntu Touch" schema={undefined}>
  <section class="section space-y-4 grow">
    <h1 class="text-4xl">Welcome {user.name || user.username}</h1>

    <ManageList server:defer />
  </section>
</BaseLayout>
