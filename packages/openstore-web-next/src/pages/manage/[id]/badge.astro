---
import BadgeSelect from "@/components/BadgeSelect";
import ManageHeader from "@/components/manage/ManageHeader.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { AppManageSchema } from "@/lib/schema";

export const prerender = false;

const { id } = Astro.params;
const apikey = Astro.cookies.get("apikey")?.value;
if (!apikey) {
  return Astro.redirect("/login/");
}

const appResponse = await fetch(`${import.meta.env.PUBLIC_API_URL}api/v3/manage/${id}?apikey=${apikey}`);

if (appResponse.status === 404) {
  return new Response(null, {
    status: 404,
    statusText: "Not found",
  });
}

if (appResponse.status === 403) {
  return Astro.redirect("/manage/");
}

if (appResponse.status !== 200) {
  Astro.cookies.delete("apikey");
  return Astro.redirect("/login/");
}

const app = await appResponse.json().then(({ data }) => AppManageSchema.parse(data));
---

<BaseLayout title="OpenStore" pageTitle={`Manage ${app.name} | OpenStore`} description={app.tagline}>
  <ManageHeader app={app} breadcrumb="Badge" />

  <section class="section mb-8">
    <h2 class="text-2xl">Badge</h2>

    <div class="w-full">
      <BadgeSelect appId={app.id} client:load />
    </div>
  </section>
</BaseLayout>
