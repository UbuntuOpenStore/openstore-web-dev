#!/usr/bin/env node

'use strict';

const { Package } = require('../db');
const Elasticsearch = require('../db/elasticsearch');

Package.find().then((pkgs) => {
    return Promise.all(pkgs.map((pkg) => {
        let revisions = pkg.revisions.map((revision) => {
            revision.channel = Package.VIVID;

            if (revision.revision == pkg.revision) {
                revision.download_url = pkg.package;
                revision.download_sha512 = pkg.download_sha512;
            }

            return revision;
        });

        return Package.update({id: pkg.id}, {$set: {revisions: revisions, channels: [Package.VIVID]}});
    }));
}).then(() => {
    console.log('done');
    process.exit(0);
}).catch((err) => {
    console.log(err);
    process.exit(1);
});
